# Backend Infrastructure

This project creates the infrastructure for an ECS-Fargate hosted app, with an ALB and RDS as a datastore.

This project relies on an ACM certificate which will need to be created previously (generated by the cdk-frontend project).

For a list of CDK commands: https://docs.aws.amazon.com/cdk/latest/guide/cli.html

## Prep

1. Get AWS AccountId and default VPC Id.
2. Determine which env needs to be deployed.
3. Add ACM cert arn to config, along with container definitions.
4. Add container definitions to config, and add `vpcId` if you want to use a specific vpc (most likely the case).

## Deploy
* Fill out or create an env specific config file in `/config`.
* Create a corresponding `{env}-backend-builder.sh` file located in `./scripts/bash`.
* Set AWS account number & env in `{env}-backend-builder.sh`.

Then run:
* Remember to replace the `env`
```
$ npm install -g aws-cdk
$ (cd scripts/bash && ./{env}-backend-builder.sh)
```
Keep the terminal running the above commands open, until the process finished. This is important because several scripts will run after the stack has been created to finish the setup.
The process is complete if there is an env-specific file in the `/task-definitions` directory.

## Tear Down

If for some reason, such as testing you would like to destroy the stack/site.
1. Manually delete RDS instances out in AWS. This may take a few minutes.
2. Delete the CF stack out in AWS or run `cdk remove -v`.
3. Delete ECRs out in AWS.
4. Delete LogGroups created by ECS.

Some of this will be automated in the future, but CDK does not support some automatic deletions yet.

## Notes

* The default DB size is `t2.Micro`, and does not allow encryption by default. [See the docs for available sizes options](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Overview.Encryption.html#Overview.Encryption.Enabling).
